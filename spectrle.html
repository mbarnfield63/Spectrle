<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spectrle</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Arial', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .game-container { max-width: 1400px; margin: 0 auto; background: white; border-radius: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); overflow: hidden; position: relative; }
        .header { background: linear-gradient(45deg, #4a90e2, #50e3c2); color: white; text-align: center; padding: 20px; }
        .header h1 { font-size: 2.5rem; margin-bottom: 10px; }
        .image-loader-section { position: absolute; top: 25px; left: 30px; z-index: 10; }
        #fileNameDisplay { display: block; margin-top: 5px; font-size: 0.8em; color: #555; background-color: rgba(255,255,255,0.7); padding: 2px 5px; border-radius: 3px; }
        .main-content { display: flex; padding: 30px; gap: 30px; min-height: 350px; }
        .image-container { flex: 2; display: flex; justify-content: center; align-items: center; background: #f8f9fa; border-radius: 15px; padding: 10px; position: relative; min-height: 300px; }
        .molecule-image { width: 100%; height: 100%; }
        .entry-section { flex: 1; display: flex; flex-direction: column; justify-content: center; }
        .entry-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin-bottom: 20px; }
        .entry-input { width: 100%; aspect-ratio: 1; border: 2px solid #ddd; border-radius: 8px; text-align: center; font-size: 1.2rem; font-weight: bold; text-transform: none; transition: all 0.3s ease; }
        .entry-input:focus { outline: none; border-color: #4a90e2; transform: scale(1.05); }
        .entry-input.correct { background-color: #4caf50; color: white; border-color: #4caf50; }
        .entry-input.wrong-position { background-color: #ff9800; color: white; border-color: #ff9800; }
        .entry-input.transition-metal { background-color: #2196f3; color: white; border-color: #2196f3; }
        .entry-input.incorrect { background-color: #f44336; color: white; border-color: #f44336; }
        .periodic-table { padding: 20px 30px; background: #f8f9fa; border-top: 1px solid #ddd; }
        .periodic-table h3 { text-align: center; margin-bottom: 20px; color: #333; }
        .periodic-grid { display: grid; grid-template-columns: repeat(18, 1fr); gap: 2px; max-width: 100%; margin: 0 auto; }
        .element { background: white; border: 1px solid #ddd; border-radius: 4px; padding: 5px; text-align: center; cursor: pointer; transition: all 0.3s ease; font-size: 0.8rem; min-height: 40px; display: flex; flex-direction: column; justify-content: center; position: relative; }
        .element.used::after,
        .element.guessed-incorrect::after { position: absolute; top: 25%; left: 25%; transform: translate(-50%, -50%); font-size: 1.5rem; font-weight: bold; }
        .element.used { background: #4caf50; color: white; }
        .element.used::after { content: '‚úì'; color: rgba(255, 255, 255, 0.7); }
        .element.guessed-incorrect::after { content: '‚úó'; color: rgba(255, 0, 0, 0.7); }
        .element.wrong-group { background: rgba(255, 152, 0, 0.25); color: #333; }
        .element.wrong { background: rgba(244, 67, 54, 0.25); color: #333; }
        .element.transition-hint { background: rgba(33, 150, 243, 0.25); color: #333; }
        .legend { display: flex; justify-content: center; gap: 20px; margin-top: 20px; flex-wrap: wrap; }
        .legend-item { display: flex; align-items: center; gap: 8px; font-size: 0.9rem; }
        .legend-color { width: 20px; height: 20px; border-radius: 4px; border: 1px solid #ccc; }
        .popup { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(255, 255, 255, 0.95); padding: 40px; border-radius: 20px; text-align: center; box-shadow: 0 20px 40px rgba(0,0,0,0.3); z-index: 1000; display: none; }
        .popup.show { display: block; }
        .popup-emoji { font-size: 4rem; margin-bottom: 20px; }
        .celebration .popup-emoji { animation: bounce 1s infinite; }
        @keyframes bounce { 0%, 20%, 50%, 80%, 100% { transform: translateY(0); } 40% { transform: translateY(-20px); } 60% { transform: translateY(-10px); } }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="image-loader-section">
            <input type="file" id="imageLoader" accept="image/*">
            <span id="fileNameDisplay"></span>
        </div>

        <div class="header">
            <h1>‚òÄÔ∏è Spectrle ü™ê</h1>
            <p>Guess the elements in the molecule!</p>
        </div>

        <div class="main-content">
            <div class="image-container">
                 <p id="imagePlaceholderText">Please load an image to begin</p>
                 <canvas class="molecule-image" style="display: none;"></canvas>
            </div>
            <div class="entry-section">
                <div class="entry-grid" id="entryGrid"></div>
            </div>
        </div>

        <div class="periodic-table">
            <h3>Periodic Table</h3>
            <div class="periodic-grid" id="periodicGrid"></div>
            <div class="legend">
                <div class="legend-item">
                    <div class="legend-color" style="background: #4caf50;"></div>
                    <span>Correct</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #ff9800;"></div>
                    <span>Right Group, Wrong Element</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #2196f3;"></div>
                    <span>Transition Metal</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #f44336;"></div>
                    <span>Incorrect</span>
                </div>
            </div>
        </div>
    </div>

    <div class="popup celebration" id="celebration">
        <div class="popup-emoji">üéâ</div>
        <h2>Congratulations!</h2>
        <p>You've identified all the elements!</p>
        <button onclick="hideCelebration()" style="margin-top: 15px; padding: 10px 20px; cursor: pointer;">Continue</button>
    </div>

    <div class="popup failure" id="failurePopup">
        <div class="popup-emoji">üòû</div>
        <h2>ExoFail! Better luck next time!</h2>
        <p>This week's molecule was: <strong id="correctAnswer"></strong></p>
        <button onclick="hideFailurePopup()" style="margin-top: 15px; padding: 10px 20px; cursor: pointer;">Close</button>
    </div>


    <script>
        // --- Game Configuration ---
        const molecule = ["P", "N"];
        const rows = 5;
        const columns = 5;

        // --- Global Variables ---
        let moleculeImageUrl = '';
        let currentInput = null;
        let usedElements = new Set();
        let isGameOver = false;
        const periodicTable = { "H": 1, "Li": 1, "Na": 1, "K": 1, "Rb": 1, "Cs": 1, "Fr": 1, "Be": 2, "Mg": 2, "Ca": 2, "Sr": 2, "Ba": 2, "Ra": 2, "Sc": 3, "Y": 3, "La": 3, "Ac": 3, "Ti": 4, "Zr": 4, "Hf": 4, "Rf": 4, "V": 5, "Nb": 5, "Ta": 5, "Db": 5, "Cr": 6, "Mo": 6, "W": 6, "Sg": 6, "Mn": 7, "Tc": 7, "Re": 7, "Bh": 7, "Fe": 8, "Ru": 8, "Os": 8, "Hs": 8, "Co": 9, "Rh": 9, "Ir": 9, "Mt": 9, "Ni": 10, "Pd": 10, "Pt": 10, "Ds": 10, "Cu": 11, "Ag": 11, "Au": 11, "Rg": 11, "Zn": 12, "Cd": 12, "Hg": 12, "Cn": 12, "B": 13, "Al": 13, "Ga": 13, "In": 13, "Tl": 13, "Nh": 13, "C": 14, "Si": 14, "Ge": 14, "Sn": 14, "Pb": 14, "Fl": 14, "N": 15, "P": 15, "As": 15, "Sb": 15, "Bi": 15, "Mc": 15, "O": 16, "S": 16, "Se": 16, "Te": 16, "Po": 16, "Lv": 16, "F": 17, "Cl": 17, "Br": 17, "I": 17, "At": 17, "Ts": 17, "He": 18, "Ne": 18, "Ar": 18, "Kr": 18, "Xe": 18, "Rn": 18, "Og": 18 };
        const elements = [ {symbol: "H", number: 1, row: 1, col: 1}, {symbol: "He", number: 2, row: 1, col: 18}, {symbol: "Li", number: 3, row: 2, col: 1}, {symbol: "Be", number: 4, row: 2, col: 2}, {symbol: "B", number: 5, row: 2, col: 13}, {symbol: "C", number: 6, row: 2, col: 14}, {symbol: "N", number: 7, row: 2, col: 15}, {symbol: "O", number: 8, row: 2, col: 16}, {symbol: "F", number: 9, row: 2, col: 17}, {symbol: "Ne", number: 10, row: 2, col: 18}, {symbol: "Na", number: 11, row: 3, col: 1}, {symbol: "Mg", number: 12, row: 3, col: 2}, {symbol: "Al", number: 13, row: 3, col: 13}, {symbol: "Si", number: 14, row: 3, col: 14}, {symbol: "P", number: 15, row: 3, col: 15}, {symbol: "S", number: 16, row: 3, col: 16}, {symbol: "Cl", number: 17, row: 3, col: 17}, {symbol: "Ar", number: 18, row: 3, col: 18}, {symbol: "K", number: 19, row: 4, col: 1}, {symbol: "Ca", number: 20, row: 4, col: 2}, {symbol: "Sc", number: 21, row: 4, col: 3}, {symbol: "Ti", number: 22, row: 4, col: 4}, {symbol: "V", number: 23, row: 4, col: 5}, {symbol: "Cr", number: 24, row: 4, col: 6}, {symbol: "Mn", number: 25, row: 4, col: 7}, {symbol: "Fe", number: 26, row: 4, col: 8}, {symbol: "Co", number: 27, row: 4, col: 9}, {symbol: "Ni", number: 28, row: 4, col: 10}, {symbol: "Cu", number: 29, row: 4, col: 11}, {symbol: "Zn", number: 30, row: 4, col: 12}, {symbol: "Ga", number: 31, row: 4, col: 13}, {symbol: "Ge", number: 32, row: 4, col: 14}, {symbol: "As", number: 33, row: 4, col: 15}, {symbol: "Se", number: 34, row: 4, col: 16}, {symbol: "Br", number: 35, row: 4, col: 17}, {symbol: "Kr", number: 36, row: 4, col: 18}, {symbol: "Rb", number: 37, row: 5, col: 1}, {symbol: "Sr", number: 38, row: 5, col: 2}, {symbol: "Y", number: 39, row: 5, col: 3}, {symbol: "Zr", number: 40, row: 5, col: 4}, {symbol: "Nb", number: 41, row: 5, col: 5}, {symbol: "Mo", number: 42, row: 5, col: 6}, {symbol: "Tc", number: 43, row: 5, col: 7}, {symbol: "Ru", number: 44, row: 5, col: 8}, {symbol: "Rh", number: 45, row: 5, col: 9}, {symbol: "Pd", number: 46, row: 5, col: 10}, {symbol: "Ag", number: 47, row: 5, col: 11}, {symbol: "Cd", number: 48, row: 5, col: 12}, {symbol: "In", number: 49, row: 5, col: 13}, {symbol: "Sn", number: 50, row: 5, col: 14}, {symbol: "Sb", number: 51, row: 5, col: 15}, {symbol: "Te", number: 52, row: 5, col: 16}, {symbol: "I", number: 53, row: 5, col: 17}, {symbol: "Xe", number: 54, row: 5, col: 18}, {symbol: "Cs", number: 55, row: 6, col: 1}, {symbol: "Ba", number: 56, row: 6, col: 2}, {symbol: "Hf", number: 72, row: 6, col: 4}, {symbol: "Ta", number: 73, row: 6, col: 5}, {symbol: "W", number: 74, row: 6, col: 6}, {symbol: "Re", number: 75, row: 6, col: 7}, {symbol: "Os", number: 76, row: 6, col: 8}, {symbol: "Ir", number: 77, row: 6, col: 9}, {symbol: "Pt", number: 78, row: 6, col: 10}, {symbol: "Au", number: 79, row: 6, col: 11}, {symbol: "Hg", number: 80, row: 6, col: 12}, {symbol: "Tl", number: 81, row: 6, col: 13}, {symbol: "Pb", number: 82, row: 6, col: 14}, {symbol: "Bi", number: 83, row: 6, col: 15}, {symbol: "Po", number: 84, row: 6, col: 16}, {symbol: "At", number: 85, row: 6, col: 17}, {symbol: "Rn", number: 86, row: 6, col: 18}, {symbol: "Fr", number: 87, row: 7, col: 1}, {symbol: "Ra", number: 88, row: 7, col: 2}, {symbol: "Rf", number: 104, row: 7, col: 4}, {symbol: "Db", number: 105, row: 7, col: 5}, {symbol: "Sg", number: 106, row: 7, col: 6}, {symbol: "Bh", number: 107, row: 7, col: 7}, {symbol: "Hs", number: 108, row: 7, col: 8}, {symbol: "Mt", number: 109, row: 7, col: 9}, {symbol: "Ds", number: 110, row: 7, col: 10}, {symbol: "Rg", number: 111, row: 7, col: 11}, {symbol: "Cn", number: 112, row: 7, col: 12}, {symbol: "Nh", number: 113, row: 7, col: 13}, {symbol: "Fl", number: 114, row: 7, col: 14}, {symbol: "Mc", number: 115, row: 7, col: 15}, {symbol: "Lv", number: 116, row: 7, col: 16}, {symbol: "Ts", number: 117, row: 7, col: 17}, {symbol: "Og", number: 118, row: 7, col: 18} ];

        // --- Event Listeners & Initial Setup ---
        document.addEventListener('DOMContentLoaded', () => {
            createEntryGrid();
            createPeriodicTable();
            document.getElementById('imageLoader').addEventListener('change', handleFiles);
        });

        // --- File & Image Handling ---
        function handleFiles(event) {
            const file = event.target.files[0];
            const fileNameDisplay = document.getElementById('fileNameDisplay');
            if (!file) {
                fileNameDisplay.textContent = '';
                return;
            }
            fileNameDisplay.textContent = file.name;
            moleculeImageUrl = URL.createObjectURL(file);
            displayMoleculeImage();
        }

        function displayMoleculeImage() {
            const canvas = document.querySelector('.molecule-image');
            const placeholder = document.getElementById('imagePlaceholderText');
            if (!moleculeImageUrl) return;

            canvas.width = canvas.clientWidth;
            canvas.height = canvas.clientHeight;

            const ctx = canvas.getContext('2d');
            const img = new Image();
            img.onload = function() {
                placeholder.style.display = 'none';
                canvas.style.display = 'block';
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                const canvasAspectRatio = canvas.width / canvas.height;
                const imageAspectRatio = img.width / img.height;
                let renderWidth, renderHeight;

                if (imageAspectRatio > canvasAspectRatio) {
                    renderWidth = canvas.width;
                    renderHeight = canvas.width / imageAspectRatio;
                } else {
                    renderHeight = canvas.height;
                    renderWidth = canvas.height * imageAspectRatio;
                }
                
                const x = (canvas.width - renderWidth) / 2;
                const y = (canvas.height - renderHeight) / 2;

                ctx.drawImage(img, x, y, renderWidth, renderHeight);
            };
            img.src = moleculeImageUrl;
        }

        // --- Game UI Functions ---
        function createEntryGrid() {
            const grid = document.getElementById('entryGrid');
            for (let r = 0; r < rows; r++) {
                for (let c = 0; c < columns; c++) {
                    const input = document.createElement('input');
                    input.className = 'entry-input';
                    input.type = 'text';
                    input.maxLength = 2;
                    input.dataset.row = r;
                    input.dataset.col = c;
                    input.addEventListener('input', handleInput);
                    input.addEventListener('keydown', handleKeyDown);
                    input.addEventListener('focus', () => currentInput = input);
                    grid.appendChild(input);
                }
            }
        }
        
        function createPeriodicTable() {
            const grid = document.getElementById('periodicGrid');
            const fragment = document.createDocumentFragment();
            for (let i = 0; i < 7 * 18; i++) fragment.appendChild(document.createElement('div'));
            elements.forEach(el => {
                const index = (el.row - 1) * 18 + (el.col - 1);
                const cell = fragment.children[index];
                cell.className = 'element';
                cell.innerHTML = `<div class="element-number">${el.number}</div><div class="element-symbol">${el.symbol}</div>`;
                cell.dataset.element = el.symbol;
                cell.addEventListener('click', () => selectElement(el.symbol));
            });
            grid.appendChild(fragment);
        }

        function handleInput(e) {
            let v = e.target.value;
            e.target.value = v.length >= 1 ? v.charAt(0).toUpperCase() + v.slice(1).toLowerCase() : v;
        }

        function handleKeyDown(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                const row = parseInt(e.target.dataset.row);
                
                if (isGameOver) return;

                checkRow(row);

                if (isGameOver) return; // Stop if checkRow triggered a win

                const isLastRow = row === rows - 1;
                if (isLastRow) {
                    showFailurePopup();
                } else {
                    const nextRowFirstInput = document.querySelector(`[data-row="${row + 1}"][data-col="0"]`);
                    if (nextRowFirstInput) nextRowFirstInput.focus();
                }
            }
        }
        
        function selectElement(symbol) {
            if (currentInput) {
                currentInput.value = symbol;
                currentInput.dispatchEvent(new Event('input'));
            }
        }

        // --- Game Logic ---
        function checkRow(rowIndex) {
            const rowInputs = Array.from(document.querySelectorAll(`[data-row="${rowIndex}"]`));
            const guess = rowInputs.map(input => input.value.trim()).filter(val => val && periodicTable[val]);
            let moleculeCheck = [...molecule];

            rowInputs.forEach(input => input.className = 'entry-input');

            // First pass: Check for correct elements
            rowInputs.forEach(input => {
                const atom = input.value.trim();
                if (!atom) return;
                const indexInAnswer = moleculeCheck.indexOf(atom);
                if (indexInAnswer > -1) {
                    input.classList.add('correct');
                    moleculeCheck[indexInAnswer] = null; // Mark as used
                    updatePeriodicTable(atom, 'used');
                    usedElements.add(atom);
                }
            });

            // Second pass: Check for incorrect and wrong-position elements
            rowInputs.forEach(input => {
                const atom = input.value.trim();
                if (!atom || input.classList.contains('correct')) return;
                if (!periodicTable[atom]) { input.classList.add('incorrect'); return; }
                const atomGroup = periodicTable[atom];
                const isGuessTM = atomGroup >= 3 && atomGroup <= 12;
                const isMoleculeTM = molecule.some(el => { const g = periodicTable[el]; return g >= 3 && g <= 12; });

                if (isGuessTM && isMoleculeTM) {
                    input.classList.add('transition-metal');
                    updatePeriodicTable(atom, 'transition-hint', true);
                } else if (molecule.some(el => periodicTable[el] === atomGroup)) {
                    input.classList.add('wrong-position');
                    updatePeriodicTable(atom, 'wrong-group', true);
                } else {
                    input.classList.add('incorrect');
                    updatePeriodicTable(atom, 'wrong', true);
                }
            });

            // Final check for win condition
            const correctCount = rowInputs.filter(input => input.classList.contains('correct')).length;
            if (correctCount === molecule.length && guess.length === molecule.length) {
                isGameOver = true;
                rowInputs.forEach(input => {
                    input.className = 'entry-input correct';
                });
                showCelebration();
            }
        }

        function updatePeriodicTable(element, status, isDirectGuess = false) {
            const cell = document.querySelector(`[data-element="${element}"]`);
            if (!cell || cell.classList.contains('used')) return;

            cell.classList.remove('wrong-group', 'wrong', 'transition-hint');
            if (status === 'used') {
                cell.classList.remove('guessed-incorrect');
            }
            
            if (status) cell.classList.add(status);

            // Add 'X' marker for any type of incorrect guess
            if (isDirectGuess && (status === 'wrong' || status === 'transition-hint' || status === 'wrong-group')) {
                cell.classList.add('guessed-incorrect');
            }

            // Color the rest of the group based on the hint type
            if (isDirectGuess && status === 'wrong') {
                const elementGroup = periodicTable[element];
                elements.forEach(el => {
                    if (el.symbol !== element && periodicTable[el.symbol] === elementGroup) {
                        const groupCell = document.querySelector(`[data-element="${el.symbol}"]`);
                        if (groupCell && !groupCell.classList.contains('used')) groupCell.classList.add('wrong');
                    }
                });
            }
            if (isDirectGuess && status === 'transition-hint') {
                elements.forEach(el => {
                    const group = periodicTable[el.symbol];
                    if (group >= 3 && group <= 12) {
                        const tmCell = document.querySelector(`[data-element="${el.symbol}"]`);
                        if (tmCell && !tmCell.classList.contains('used')) tmCell.classList.add('transition-hint');
                    }
                });
            }
            if (isDirectGuess && status === 'wrong-group') {
                const elementGroup = periodicTable[element];
                elements.forEach(el => {
                    if (el.symbol !== element && periodicTable[el.symbol] === elementGroup) {
                        const groupCell = document.querySelector(`[data-element="${el.symbol}"]`);
                        if (groupCell && !groupCell.classList.contains('used')) groupCell.classList.add('wrong-group');
                    }
                });
            }
        }

        // --- Popups ---
        function showCelebration() {
            isGameOver = true;
            document.getElementById('celebration').classList.add('show');
        }

        function hideCelebration() {
            document.getElementById('celebration').classList.remove('show');
        }

        function showFailurePopup() {
            isGameOver = true;
            document.getElementById('correctAnswer').textContent = molecule.join(' ');
            document.getElementById('failurePopup').classList.add('show');
        }

        function hideFailurePopup() {
            document.getElementById('failurePopup').classList.remove('show');
        }
    </script>
</body>
</html>